<!DOCTYPE html>
<html>
<head>
    <title>Finance Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .step { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 15px; background: #e9ecef; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .transaction { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; background: white; }
        .amount { font-weight: bold; color: #dc3545; }
        .positive { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ Finance Assistant</h1>
        
        <div class="step">
            <h3>Option A: Real Plaid Link Experience</h3>
            <button onclick="initializePlaidLink()">Connect Your Bank (Plaid Link)</button>
            <div id="link-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="step">
            <h3>Option B: Quick Sandbox Testing</h3>
            <button onclick="createSandboxToken()">Create Sandbox Token</button>
            <div id="sandbox-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="step">
            <h3>Step 2: Exchange Token</h3>
            <button onclick="exchangeToken()">Exchange Token</button>
            <div id="exchange-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="step">
            <h3>Step 3: Get Transactions</h3>
            <button onclick="getTransactions()">Get Transactions (Single Account)</button>
            <button onclick="getAllTransactions()">Get ALL Transactions (Multiple Banks)</button>
            <button onclick="getCustomTransactions()">Get Transactions + Netflix/Spotify</button>
            <button onclick="debugTransactions()">üîç Debug Plaid Categories</button>
            <div id="transactions-result"></div>
        </div>
        
        <div class="step">
            <h3>Step 4: Test Plaid Features</h3>
            <button onclick="testCategories()">üìã Get All Categories</button>
            <button onclick="testRecurring()">üîÑ Get Recurring Transactions</button>
            <button onclick="forecastSpending()">üîÆ Forecast Spending</button>
            <button onclick="identifySubscriptions()">üí≥ Find Subscriptions</button>
            <button onclick="runFullAnalysis()" style="background: #dc3545;">ü§ñ Run Full AI Analysis</button>
            <div id="plaid-features-result"></div>
        </div>
    </div>
    
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
        let publicToken = '';
        let accessToken = '';
        let linkToken = '';
        
        async function createSandboxToken() {
            const response = await fetch('http://localhost:8000/api/create_sandbox_token', { method: 'POST' });
            const data = await response.json();
            publicToken = data.public_token;
            document.getElementById('sandbox-result').style.display = 'block';
            document.getElementById('sandbox-result').textContent = `Public Token: ${publicToken}`;
        }
        
        async function exchangeToken() {
            if (!publicToken) {
                alert('Create sandbox token first!');
                return;
            }
            const response = await fetch('http://localhost:8000/api/exchange_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ public_token: publicToken })
            });
            const data = await response.json();
            accessToken = data.access_token;
            document.getElementById('exchange-result').style.display = 'block';
            document.getElementById('exchange-result').textContent = `Access Token: ${accessToken}`;
        }
        
        async function getTransactions() {
            if (!accessToken) {
                alert('Exchange token first!');
                return;
            }
            const response = await fetch('http://localhost:8000/api/get_transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_token: accessToken })
            });
            const data = await response.json();
            displayTransactions(data);
        }
        
        async function getAllTransactions() {
            if (!accessToken) {
                alert('Exchange token first!');
                return;
            }
            const response = await fetch('http://localhost:8000/api/get_all_transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_token: accessToken })
            });
            const data = await response.json();
            displayTransactions(data);
        }
        
        async function initializePlaidLink() {
            try {
                // First get a link token
                console.log('Fetching link token...');
                const response = await fetch('http://localhost:8000/api/create_link_token', { method: 'POST' });
                const data = await response.json();
                console.log('Link token response:', data);
                
                if (data.error) {
                    alert('Error creating link token: ' + data.error);
                    return;
                }
                
                linkToken = data.link_token;
                console.log('Link token received:', linkToken);
                
                // Initialize Plaid Link
                console.log('Initializing Plaid Link...');
                const handler = Plaid.create({
                    token: linkToken,
                onSuccess: (public_token, metadata) => {
                    publicToken = public_token;
                    document.getElementById('link-result').style.display = 'block';
                    document.getElementById('link-result').textContent = `Connected to ${metadata.institution.name}! Public Token: ${publicToken}`;
                    
                    // Auto-exchange token
                    exchangeToken();
                },
                onLoad: () => {
                    console.log('Plaid Link loaded');
                },
                onExit: (err, metadata) => {
                    if (err != null) {
                        console.log('Error:', err);
                    }
                },
                onEvent: (eventName, metadata) => {
                    console.log('Event:', eventName, metadata);
                },
                });
                
                console.log('Opening Plaid Link...');
                handler.open();
            } catch (error) {
                console.error('Error initializing Plaid Link:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function displayTransactions(data) {
            const container = document.getElementById('transactions-result');
            if (data.error) {
                container.innerHTML = `<div class="result">Error: ${data.error}</div>`;
                return;
            }
            
            let html = '<h3>üí≥ Accounts & Transactions</h3>';
            
            if (data.accounts) {
                html += `<h4>Accounts (${data.accounts.length}):</h4>`;
                data.accounts.forEach(account => {
                    html += `<div class="transaction">
                        <strong>${account.name}</strong> (${account.subtype})<br>
                        Balance: $${account.balances?.current || 'N/A'}
                    </div>`;
                });
            }
            
            if (data.transactions) {
                html += `<h4>Recent Transactions (${data.transactions.length}):</h4>`;
                data.transactions.forEach(tx => {
                    const isPositive = tx.amount < 0;
                    html += `<div class="transaction">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${tx.name || tx.merchant_name || 'Unknown'}</strong><br>
                                <small>${tx.date} ‚Ä¢ ${tx.category?.join(', ') || 'Uncategorized'}</small>
                            </div>
                            <div class="amount ${isPositive ? 'positive' : ''}">
                                ${isPositive ? '+' : '-'}$${Math.abs(tx.amount).toFixed(2)}
                            </div>
                        </div>
                    </div>`;
                });
            }
            
            
            container.innerHTML = html;
        }

        async function forecastSpending() {
            const response = await fetch('http://localhost:8000/api/forecast_spending');
            const data = await response.json();
            const container = document.getElementById('plaid-features-result');
            if (data.error) {
                container.innerHTML = `<div class="result">Error: ${data.error}</div>`;
                return;
            }
            let html = `<h3>üîÆ Spending Forecast - Total (Next 2 Weeks): $${data.total_forecast}</h3>`;
            if (data.forecasted_weeks && data.forecasted_weeks.length > 0) {
                html += '<div class="transaction">';
                html += '<strong>Forecasted Weeks:</strong><ul>';
                data.forecasted_weeks.forEach(week => {
                    html += `<li>${week.ds}: $${week.yhat.toFixed(2)}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            if (data.chart_image) {
                html += `<img src="data:image/png;base64,${data.chart_image}" style="width: 100%; max-width: 600px; margin-top: 10px; border-radius: 5px;">`;
            }
            container.innerHTML = html;
        }
        
        async function identifySubscriptions() {
            const response = await fetch('http://localhost:8000/api/identify_subscriptions');
            const data = await response.json();
            const container = document.getElementById('plaid-features-result');
            if (data.error) {
                container.innerHTML = `<div class="result">Error: ${data.error}</div>`;
                return;
            }
            let html = `<h3>üí≥ Subscriptions - Total: $${data.total_monthly_cost}/month</h3>`;
            if (data.subscriptions && data.subscriptions.length > 0) {
                data.subscriptions.forEach(sub => {
                    html += `<div class="transaction">
                        <strong>${sub.merchant}</strong> - $${sub.amount} (${sub.frequency})
                    </div>`;
                });
            } else {
                html += '<div class="result">No subscriptions detected</div>';
            }
            container.innerHTML = html;
        }
        
        async function runFullAnalysis() {
            const response = await fetch('http://localhost:8000/api/analyze_finances', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: 'Analyze my complete financial situation' })
            });
            const data = await response.json();
            const container = document.getElementById('plaid-features-result');
            if (data.error) {
                container.innerHTML = `<div class="result">Error: ${data.error}</div>`;
                return;
            }
            
            let html = '<h3>ü§ñ Complete AI Financial Analysis</h3>';
            
            // Forecast
            if (data.forecast && data.forecast.total_4week_forecast) {
                html += `<div class="transaction">
                    <strong>4-Week Forecast:</strong> $${data.forecast.total_4week_forecast}<br>
                    <small>Weekly: ${data.forecast.weekly_breakdown?.join(', ') || 'N/A'}</small>
                </div>`;
            }
            
            // Alerts
            if (data.alerts && data.alerts.length > 0) {
                html += '<div class="transaction" style="border-color: #dc3545;">';
                html += '<strong>Alerts:</strong><ul>';
                data.alerts.forEach(alert => {
                    html += `<li>${alert}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Subscriptions
            if (data.subscriptions && data.subscriptions.length > 0) {
                html += '<div class="transaction">';
                html += '<strong>Subscriptions Found:</strong><ul>';
                data.subscriptions.forEach(sub => {
                    html += `<li>${sub.merchant}: $${sub.amount} (${sub.frequency})</li>`;
                });
                html += '</ul></div>';
            }
            
            // AI Response
            if (data.chat_response) {
                html += `<div class="transaction">
                    <strong>AI Analysis:</strong><br>
                    <small>${data.chat_response}</small>
                </div>`;
            }
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>